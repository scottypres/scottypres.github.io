name: TFR West Palm Alerts

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write  # allow commits via GITHUB_TOKEN

jobs:
  poll:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------
      # CHECK OUT REPO SAFELY (full history, no deletion)
      # -----------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0    # needed so commits are not detached
          clean: false      # prevents GH Pages cleanup from deleting your files

      # -----------------------------------------------
      # DEBUG (optional but recommended)
      # -----------------------------------------------
      - name: Show working directory
        run: |
          pwd
          ls -la

      # -----------------------------------------------
      # RUN PYTHON SCRIPT
      # -----------------------------------------------
      - name: Check TFR feed and notify via Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          STATE_FILE="state/last_wpb.json"

          # Ensure state folder exists
          mkdir -p state

          python - <<'PYCODE'
# --- PYTHON SCRIPT (unchanged except for path) ---
import datetime
from zoneinfo import ZoneInfo
import json, os, re, sys
from pathlib import Path
import urllib.parse, urllib.request
import xml.etree.ElementTree as ET

FEED_URL = "https://tfr.faa.gov/tfrapi/exportTfrList"
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
STATE_FILE = Path("state") / "last_wpb.json"
ET_ZONE = ZoneInfo("America/New_York")
TZ_RE = re.compile(r"(Z|[+-]\d{2}:?\d{2})$")

def fetch_json(url):
    with urllib.request.urlopen(url, timeout=15) as resp:
        return json.loads(resp.read().decode())

def fetch_detail(notam_id):
    url_id = notam_id.replace("/", "_")
    url = f"https://tfr.faa.gov/download/detail_{url_id}.xml"
    with urllib.request.urlopen(url, timeout=15) as resp:
        xml_text = resp.read()
    root = ET.fromstring(xml_text)
    eff = root.find(".//dateEffective")
    exp = root.find(".//dateExpire")
    return {
        "effective": eff.text if eff is not None else None,
        "expires": exp.text if exp is not None else None,
    }

def parse_utc(dt_str):
    if not dt_str:
        return None
    dt_str = dt_str.strip()
    if not TZ_RE.search(dt_str):
        dt_str = f"{dt_str}Z"
    try:
        return datetime.datetime.fromisoformat(dt_str.replace("Z", "+00:00"))
    except ValueError:
        return None

def format_et(dt_obj):
    if not dt_obj:
        return "N/A"
    return dt_obj.astimezone(ET_ZONE).strftime("%Y-%m-%d %a %I:%M %p %Z")

def load_state(path):
    path.parent.mkdir(parents=True, exist_ok=True)
    if not path.exists():
        return {"seen": {}}
    with path.open("r", encoding="utf-8") as f:
        data = json.load(f)
    if "seen_ids" in data and "seen" not in data:
        data = {"seen": {i: {} for i in data.get("seen_ids", [])}}
    if "seen" not in data:
        data["seen"] = {}
    return data

def save_state(path, data):
    path.parent.mkdir(parents=True, exist_ok=True)
    with path.open("w", encoding="utf-8") as f:
        json.dump(data, f, indent=2, sort_keys=True)

def send_telegram(body):
    if not (TOKEN and CHAT_ID):
        print("Telegram env vars missing; skipping send.")
        return
    data = urllib.parse.urlencode({
        "chat_id": CHAT_ID,
        "text": body,
    }).encode()
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    req = urllib.request.Request(url, data=data, headers={"Content-Type": "application/x-www-form-urlencoded"})
    with urllib.request.urlopen(req, timeout=10) as resp:
        print("Telegram status:", resp.status)

def main():
    now = datetime.datetime.now(datetime.timezone.utc)
    feed = fetch_json(FEED_URL)
    wpb = [n for n in feed if ("west palm beach" in n.get("description","").lower()) or ("PBI" in n.get("description",""))]

    state = load_state(STATE_FILE)
    seen = state.get("seen", {})

    current_active = {}
    new_msgs = []
    revoke_msgs = []

    for n in wpb:
        notam_id = n.get("notam_id")
        if not notam_id:
            continue
        try:
            detail = fetch_detail(notam_id)
        except Exception as exc:
            print(f"Failed detail fetch for {notam_id}: {exc}")
            continue

        eff_dt = parse_utc(detail.get("effective"))
        exp_dt = parse_utc(detail.get("expires"))
        if not exp_dt:
            continue
        if exp_dt <= now:
            continue

        current_active[notam_id] = {
            "effective": eff_dt.isoformat() if eff_dt else None,
            "expires": exp_dt.isoformat(),
            "description": n.get("description", "").strip(),
        }

        if notam_id not in seen:
            desc = n.get("description","").strip()
            start_str = format_et(eff_dt)
            end_str = format_et(exp_dt)
            link = f"https://tfr.faa.gov/tfr3/?page=detail_{notam_id.replace('/', '_')}"
            new_msgs.append(
                f"- {notam_id}: {desc} (type: {n.get('type','?')})\n"
                f"  Starts: {start_str}\n"
                f"  Ends: {end_str}\n"
                f"  Link: {link}"
            )
            seen[notam_id] = current_active[notam_id]
        else:
            seen[notam_id].update(current_active[notam_id])

    # Handle revocations
    for notam_id, info in list(seen.items()):
        exp_dt = parse_utc(info.get("expires"))
        if exp_dt and exp_dt <= now:
            seen.pop(notam_id, None)
            continue
        if notam_id not in current_active:
            revoke_msgs.append(f"- {notam_id} revoked before expiration")
            seen.pop(notam_id, None)

    messages = []
    if new_msgs:
        messages.append("New West Palm Beach TFR(s) detected:\n" + "\n".join(new_msgs))
    if revoke_msgs:
        messages.append("TFR(s) revoked early:\n" + "\n".join(revoke_msgs))

    if messages:
        send_telegram("\n\n".join(messages))

    state["seen"] = seen
    save_state(STATE_FILE, state)

if __name__ == "__main__":
    main()
    sys.exit(0)
PYCODE

      # -----------------------------------------------
      # COMMIT STATE IF CHANGED ? SAFELY
      # -----------------------------------------------
      - name: Commit state if changed
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only commit if there are actual changes
          if ! git diff --quiet; then
            git add state/last_wpb.json
            git commit -m "Update TFR state"
            git push
          else
            echo "No state change to commit."
          fi
